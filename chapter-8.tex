\chapter{Operacje na wynikach wyszukiwania}

Istnieją sytuacje, w których samo uzyskanie dokumentów pasujących do zapytania nie wystarczy -- wyniki muszą zostać poddane dodatkowej obróbce, zanim zostaną przedstawione użytkownikowi. Lucene pozwala na wykonywanie kilku operacji tego typu.

\section{Pozyskiwanie informacji o wynikach, klasa \texttt{TopDocs}}

Operacja \texttt{search()} wykonana na instancji klasy \texttt{IndexReader} zwraca obiekt \texttt{TopDocs}, zawierający odnośniki do dokumentów pasujących do zapytania. Możemy z niej pobrać numery oraz obliczone miary dopasowania (``score'') dla $n$ najlepiej ocenionych dokumentów (gdzie $n$ jest parametrem metody \texttt{search()}).

\section{Sortowanie wyników}

Domyślnie wyniki wyszukiwania posortowane są w pierwszej kolejności malejąco względem miary dopasowania, a następnie -- rosnąco, zgodnie z numerami dokumentów (czyli zogdnie z kolejnością, w jakiej dokumenty były dodawane do indeksu). Można to jednak zmienić. Jedna z przeciążeń metody \texttt{IndexReader.search()} przyjmuje jako parametr obiekt \texttt{Sort}, definiujący rządany porządek wyników. Okrojony przykład konstrukcji i wykorzystania takiego obiektu znajduje się poniżej.

\begin{lstlisting}
public TopDocs runSearchWithSort(Directory indexDir, String sortFieldName, SortField.Type sortFieldType)
    throws IOException {
  // Create and index documents.  
  index(indexDir);
  // Create an IndexSearcher.
  IndexSearcher searcher = createSearcher(indexDir);
  // Query the index and sort the results by numeric fields.
  TopDocs topDocs = queryWithSort(searcher, sortFieldName, sortFieldType);
  // Display results to the user.
  displayResults(sortFieldName, searcher, topDocs, sortFieldType.name());
  return topDocs;
}

private TopDocs queryWithSort(IndexSearcher searcher, String sortFieldName, SortField.Type sortFieldType)
    throws IOException {
  SortField sortField = new SortField(sortFieldName, sortFieldType);
  Sort sort = new Sort(sortField);
  return searcher.search(new MatchAllDocsQuery(), MAX_DOCS, sort);
}
\end{lstlisting}

Metoda \texttt{queryWithSort} obrazuje tworzenie obiektu \texttt{Sort} na podstawie pola, po wartościach którego zostaną posortowane wyniki. \texttt{SortField} potrzebuje wskazania nazwy oraz typu takiego pola. 

W przykładzie zostało użyte zapytanie typu \texttt{MatchAllDocsQuery} -- dopasowuje się ono do wszystkich dokumentów obecnych w indeksie. Stosowane jest głównie w testach.

\section{Filtrowanie wyników}

Filtrowanie polega na odrzuceniu pewnej części wyników. Może być przydatne np. w sytuacji, gdy nie wszyscy użytkownicy systemu wyszukującego mają dostęp do wszystkich dokumentów, albo gdy chcemy zawęzić wyniki wyszukiwania do pewnej grupy (np. chcemy pokazywać użytkownikowi tylko wyniki należące do określonej kategorii).

Z programistycznego punktu widzenia, implementacja takiej funkcjonalności opiera się na dostarczeniu obiektu typu \texttt{Filter} do odpowiedniej wersji metody \texttt{IndexReader.search()}. Lucene umożliwia tworzenie filtrów na podstawie termów, ich grup, prefiksów lub zakresów (dokumenty zawierające dany term zostaną wykluczone) oraz zakresów wartości numerycznych. Z logicznego punktu widzenia, zastosowanie takiego filtra na zbiorze wyników nie różnią się niczym od zbudowania zapytania typu \texttt{BooleanQuery} z dodatkową klauzulą. W tym wypadku powodem do zastosowania filtra może być np. zwiększenie czytelności kodu. 

Istnieją jednak przypadki, w których informacje o tym, które wyniki nie powinny być prezentowane użytkownikowi nie są dostępne w czasie indeksowania. Tutaj zastosowanie filtra jest jedynym rozwiązaniem. Dodatkowo, filtry mają tę przewagę nad zapytaniami, że po utworzeniu mogą być stosowane wielokrotnie na wynikach, bez konieczności otwierania indeksu -- filtrowanie tym sposobem trwa krócej. 

\section{Klasa Collector}

\texttt{Collector} jest elementem pośredniczącym pomiędzy nieobrobionym zbiorem wszystkich pasujących do zapytania dokumentów (przechowywanym przez pewnien czas) w wynikami zwracanymi w postaci \texttt{TopDocs}. Jego główna metoda, \texttt{Collector.collect()} jest wywoływana dla każdego pasującego dokumentu -- nie tylko dla tych najlepiej ocenionych. 

Rozszerzenie domyślnej implementacji \texttt{Collectora} (lub dostarczenie jego własnej wersji) pozwala na np. na wprowadzenie dodatkowego filtra dokumentów lub obliczenie statystyk na surowych wynikach wyszukiwania.