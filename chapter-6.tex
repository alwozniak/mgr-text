\chapter{Wyszukiwanie (prawie) natychmiast po indeksowaniu}

\emph{Near real-time search} (czyli prawie natychmiastowe wyszukiwanie) jest funkcjonalnością dodaną w wersji 2.9 Lucene. Umożliwia ona przeszukiwanie najnowszych zmian wprowadzonych do indeksu, nawet jeśli nie zostały one jeszcze zacommitowane. 

Przypomnijmy, że w zaprezentowanym w rozdziale pierwszym przykładzie dokumenty najpierw zostały zaindeksowane i zacommitowane, a dopiero później można było je wyszukiwać. W rzeczywistych zastosowaniach programista często nie może sobie pozwolić na taki scenariusz: dokumenty powinny być dostępne natychmiast po ich dodaniu do indeksu, nawet jeśli commit (będący czasochłonną i kosztowną operacją, szczególnie jeśli wprowadzono w nim sporo zmian) się jeszcze nie zakończył. \emph{Near real-time search} pozwala w dowolnym momencie pobrać stanu indeksu -- wyszukiwanie w takim indeksie może być jednak wolniejsze niż w przypadku, w którym wyszukiwanie jest poprzedzone commitem. Każdy commit wiąże się bowiem z optymalizacją indeksu.

\section{Commit w Lucene}

Commit w Lucene odbywa się według następującego schematu:
\begin{enumerate}
 \item \emph{flush} -- wprowadzane zmiany są zapisywane na dysku,
 \item następuje synchronizacja plików dyskowych -- konkretne czynności wykonywane podczas tej fazy są zależne od systemu operacyjnego i wykorzystywanego systemu plików
 \item zapisywany jest plik \texttt{segments\_N} zawierający szczegółowe informacje o indeksie (m.in. numer obecnej generacji indeksu)
 \item usuwane są stare commity (istnieje możliwość przechowywania stanu indeksu sprzed określonej liczby commitów. To, które z tych stanów są usuwane -- i kiedy -- określane jest przez implementację klasy \texttt{IndexDeletionPolicy}).
\end{enumerate}

Po każdym commicie może nastąpić optymalizacja indeksu: łączenie segmentów oraz fizyczne usuwanie dokumentów, które nie powinny występować w wynikach wyszukiwania.

\section{Algorytm budowania i optymalizacji indeksu}

Jak zostało to już wspomniane, indeks w Lucene składa się z jednego bądź wielu segmentów. Rozwiązanie takie pozwala na skrócenie czasu dodawania nowych dokumentów do indeksu, jednak jego wadą jest potencjalne wydłużenie czasu wyszukiwania. Dlatego, aby zachować równowagę pomiędzy optymalnym czasem wyszukiwania i dodawania nowych dokumentów, w Lucene zastosowano generacyjny algorytm łączenia segmentów podobny do partycjonowania geometrycznego \cite{geopart}. 

Nowy segment jest tworzony i zapisywany na dysk w jednej z następujących sytuacji:
\begin{itemize}
 \item gdy liczba dokumentów dodanych w obecnie trwającym commicie przekroczy ustaloną wartość \emph{maxDocs},
 \item gdy łączna pamięć operacyjna zajęta przez dodane właśnie dokumenty przekroczy wartość współczynnika \emph{maxBufferSize}.
\end{itemize}
Świeżo utworzony segment należy do segmentów poziomu 0. Jeśli w indeksie znajduje się odpowiednia liczba segmentów tego samego poziomu $n$ (wartość ta jest ustalana przez współczynnik \emph{mergeFactor}), następuje połączenie (``merge'') tych segmentów w jeden większy -- segment poziomu $n+1$. Każdy tworzony segment (powstały jako zrzut nowododanych dokumentów na dysk lub jako połączenie mniejszych segmentów) dostaje swój unikalny numer. Numer najmłodszego segmentu jest przechowywany w pliku \texttt{segments\_N} i określany jest jako \emph{generacja} indeksu.

W wyniku działania algorytmu, w idealnym przypadku, pomijając usuwanie dokumentów, powstaje indeks o strukturze schodkowej. Każdy poziom ma maksymalnie $\emph{mergeFactor} - 1$ segmentów. Segmenty każdego poziomu są o \emph{mergeFactor} większe od segmentów poziomu niższego (rozmiar najmłodszych segmentów jest regulowany parametrem \emph{maxBufferSize}).

Sposób wyboru segmentów do połączenia oraz momentu, w którym ma odbyć się łączenie mogą być modyfikowane przez programistę (należy dostarczyć implementacji abstrakcyjnych klas \texttt{MergePolicy} oraz \texttt{MergeScheduler}). Łączenie jest operacją kosztowną, szczególnie dla dużych segmentów. Dlatego odbywa się w osobnym wątku -- aby nakład pracy z nią związany nie miał wpływu na czas wyszukiwania. Dodatkowo, domyślne ustawienia nie pozwalają na łączenie bardzo dużych segmentów (obecnie, większych niż 5GB).
